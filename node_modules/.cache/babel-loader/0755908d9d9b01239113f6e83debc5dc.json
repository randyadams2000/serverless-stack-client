{"ast":null,"code":"\"use strict\";var __extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b;}||function(d,b){for(var p in b){if(b.hasOwnProperty(p))d[p]=b[p];}};return function(d,b){extendStatics(d,b);function __(){this.constructor=d;}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __());};}();Object.defineProperty(exports,\"__esModule\",{value:true});var events_1=require(\"events\");var tools=require(\"./tools\");/**\n * This is an informal code for reference.\n * EBMLReader is a class for getting information to enable seeking Webm recorded by MediaRecorder.\n * So please do not use for regular WebM files.\n */var EBMLReader=function(_super){__extends(EBMLReader,_super);function EBMLReader(){var _this=_super.call(this)||this;_this.logGroup=\"\";_this.hasLoggingStarted=false;_this.metadataloaded=false;_this.chunks=[];_this.stack=[];_this.segmentOffset=0;_this.last2SimpleBlockVideoTrackTimecode=[0,0];_this.last2SimpleBlockAudioTrackTimecode=[0,0];_this.lastClusterTimecode=0;_this.lastClusterPosition=0;_this.timecodeScale=1000000;// webm default TimecodeScale is 1ms\n_this.metadataSize=0;_this.metadatas=[];_this.cues=[];_this.firstVideoBlockRead=false;_this.firstAudioBlockRead=false;_this.currentTrack={TrackNumber:-1,TrackType:-1,DefaultDuration:null,CodecDelay:null};_this.trackTypes=[];_this.trackDefaultDuration=[];_this.trackCodecDelay=[];_this.trackInfo={type:\"nothing\"};_this.ended=false;_this.logging=false;_this.use_duration_every_simpleblock=false;_this.use_webp=false;_this.use_segment_info=true;_this.drop_default_duration=true;return _this;}/**\n     * emit final state.\n     */EBMLReader.prototype.stop=function(){this.ended=true;this.emit_segment_info();// clean up any unclosed Master Elements at the end of the stream.\nwhile(this.stack.length){this.stack.pop();if(this.logging){console.groupEnd();}}// close main group if set, logging is enabled, and has actually logged anything.\nif(this.logging&&this.hasLoggingStarted&&this.logGroup){console.groupEnd();}};/**\n     * emit chunk info\n     */EBMLReader.prototype.emit_segment_info=function(){var data=this.chunks;this.chunks=[];if(!this.metadataloaded){this.metadataloaded=true;this.metadatas=data;var videoTrackNum=this.trackTypes.indexOf(1);// find first video track\nvar audioTrackNum=this.trackTypes.indexOf(2);// find first audio track\nthis.trackInfo=videoTrackNum>=0&&audioTrackNum>=0?{type:\"both\",trackNumber:videoTrackNum}:videoTrackNum>=0?{type:\"video\",trackNumber:videoTrackNum}:audioTrackNum>=0?{type:\"audio\",trackNumber:audioTrackNum}:{type:\"nothing\"};if(!this.use_segment_info){return;}this.emit(\"metadata\",{data:data,metadataSize:this.metadataSize});}else{if(!this.use_segment_info){return;}var timecode=this.lastClusterTimecode;var duration=this.duration;var timecodeScale=this.timecodeScale;this.emit(\"cluster\",{timecode:timecode,data:data});this.emit(\"duration\",{timecodeScale:timecodeScale,duration:duration});}};EBMLReader.prototype.read=function(elm){var _this=this;var drop=false;if(this.ended){// reader is finished\nreturn;}if(elm.type===\"m\"){// 閉じタグの自動挿入\nif(elm.isEnd){this.stack.pop();}else{var parent_1=this.stack[this.stack.length-1];if(parent_1!=null&&parent_1.level>=elm.level){// 閉じタグなしでレベルが下がったら閉じタグを挿入\nthis.stack.pop();// From http://w3c.github.io/media-source/webm-byte-stream-format.html#webm-media-segments\n// This fixes logging for webm streams with Cluster of unknown length and no Cluster closing elements.\nif(this.logging){console.groupEnd();}parent_1.dataEnd=elm.dataEnd;parent_1.dataSize=elm.dataEnd-parent_1.dataStart;parent_1.unknownSize=false;var o=Object.assign({},parent_1,{name:parent_1.name,type:parent_1.type,isEnd:true});this.chunks.push(o);}this.stack.push(elm);}}if(elm.type===\"m\"&&elm.name==\"Segment\"){if(this.segmentOffset!=0){console.warn(\"Multiple segments detected!\");}this.segmentOffset=elm.dataStart;this.emit(\"segment_offset\",this.segmentOffset);}else if(elm.type===\"b\"&&elm.name===\"SimpleBlock\"){var _a=tools.ebmlBlock(elm.data),timecode=_a.timecode,trackNumber=_a.trackNumber,frames_1=_a.frames;if(this.trackTypes[trackNumber]===1){if(!this.firstVideoBlockRead){this.firstVideoBlockRead=true;if(this.trackInfo.type===\"both\"||this.trackInfo.type===\"video\"){var CueTime=this.lastClusterTimecode+timecode;this.cues.push({CueTrack:trackNumber,CueClusterPosition:this.lastClusterPosition,CueTime:CueTime});this.emit(\"cue_info\",{CueTrack:trackNumber,CueClusterPosition:this.lastClusterPosition,CueTime:this.lastClusterTimecode});this.emit(\"cue\",{CueTrack:trackNumber,CueClusterPosition:this.lastClusterPosition,CueTime:CueTime});}}this.last2SimpleBlockVideoTrackTimecode=[this.last2SimpleBlockVideoTrackTimecode[1],timecode];}else if(this.trackTypes[trackNumber]===2){if(!this.firstAudioBlockRead){this.firstAudioBlockRead=true;if(this.trackInfo.type===\"audio\"){var CueTime=this.lastClusterTimecode+timecode;this.cues.push({CueTrack:trackNumber,CueClusterPosition:this.lastClusterPosition,CueTime:CueTime});this.emit(\"cue_info\",{CueTrack:trackNumber,CueClusterPosition:this.lastClusterPosition,CueTime:this.lastClusterTimecode});this.emit(\"cue\",{CueTrack:trackNumber,CueClusterPosition:this.lastClusterPosition,CueTime:CueTime});}}this.last2SimpleBlockAudioTrackTimecode=[this.last2SimpleBlockAudioTrackTimecode[1],timecode];}if(this.use_duration_every_simpleblock){this.emit(\"duration\",{timecodeScale:this.timecodeScale,duration:this.duration});}if(this.use_webp){frames_1.forEach(function(frame){var startcode=frame.slice(3,6).toString(\"hex\");if(startcode!==\"9d012a\"){return;};// VP8 の場合\nvar webpBuf=tools.VP8BitStreamToRiffWebPBuffer(frame);var webp=new Blob([webpBuf],{type:\"image/webp\"});var currentTime=_this.duration;_this.emit(\"webp\",{currentTime:currentTime,webp:webp});});}}else if(elm.type===\"m\"&&elm.name===\"Cluster\"&&elm.isEnd===false){this.firstVideoBlockRead=false;this.firstAudioBlockRead=false;this.emit_segment_info();this.emit(\"cluster_ptr\",elm.tagStart);this.lastClusterPosition=elm.tagStart;}else if(elm.type===\"u\"&&elm.name===\"Timecode\"){this.lastClusterTimecode=elm.value;}else if(elm.type===\"u\"&&elm.name===\"TimecodeScale\"){this.timecodeScale=elm.value;}else if(elm.type===\"m\"&&elm.name===\"TrackEntry\"){if(elm.isEnd){this.trackTypes[this.currentTrack.TrackNumber]=this.currentTrack.TrackType;this.trackDefaultDuration[this.currentTrack.TrackNumber]=this.currentTrack.DefaultDuration;this.trackCodecDelay[this.currentTrack.TrackNumber]=this.currentTrack.CodecDelay;}else{this.currentTrack={TrackNumber:-1,TrackType:-1,DefaultDuration:null,CodecDelay:null};}}else if(elm.type===\"u\"&&elm.name===\"TrackType\"){this.currentTrack.TrackType=elm.value;}else if(elm.type===\"u\"&&elm.name===\"TrackNumber\"){this.currentTrack.TrackNumber=elm.value;}else if(elm.type===\"u\"&&elm.name===\"CodecDelay\"){this.currentTrack.CodecDelay=elm.value;}else if(elm.type===\"u\"&&elm.name===\"DefaultDuration\"){// media source api は DefaultDuration を計算するとバグる。\n// https://bugs.chromium.org/p/chromium/issues/detail?id=606000#c22\n// chrome 58 ではこれを回避するために DefaultDuration 要素を抜き取った。\n// chrome 58 以前でもこのタグを抜き取ることで回避できる\nif(this.drop_default_duration){console.warn(\"DefaultDuration detected!, remove it\");drop=true;}else{this.currentTrack.DefaultDuration=elm.value;}}else if(elm.name===\"unknown\"){console.warn(elm);}if(!this.metadataloaded&&elm.dataEnd>0){this.metadataSize=elm.dataEnd;}if(!drop){this.chunks.push(elm);}if(this.logging){this.put(elm);}};Object.defineProperty(EBMLReader.prototype,\"duration\",{/**\n         * DefaultDuration が定義されている場合は最後のフレームのdurationも考慮する\n         * 単位 timecodeScale\n         *\n         * !!! if you need duration with seconds !!!\n         * ```js\n         * const nanosec = reader.duration * reader.timecodeScale;\n         * const sec = nanosec / 1000 / 1000 / 1000;\n         * ```\n         */get:function get(){if(this.trackInfo.type===\"nothing\"){console.warn(\"no video, no audio track\");return 0;}// defaultDuration は 生の nano sec\nvar defaultDuration=0;// nanoseconds\nvar codecDelay=0;var lastTimecode=0;var _defaultDuration=this.trackDefaultDuration[this.trackInfo.trackNumber];if(typeof _defaultDuration===\"number\"){defaultDuration=_defaultDuration;}else{// https://bugs.chromium.org/p/chromium/issues/detail?id=606000#c22\n// default duration がないときに使う delta\nif(this.trackInfo.type===\"both\"){if(this.last2SimpleBlockAudioTrackTimecode[1]>this.last2SimpleBlockVideoTrackTimecode[1]){// audio diff\ndefaultDuration=(this.last2SimpleBlockAudioTrackTimecode[1]-this.last2SimpleBlockAudioTrackTimecode[0])*this.timecodeScale;// audio delay\nvar delay=this.trackCodecDelay[this.trackTypes.indexOf(2)];// 2 => audio\nif(typeof delay===\"number\"){codecDelay=delay;}// audio timecode\nlastTimecode=this.last2SimpleBlockAudioTrackTimecode[1];}else{// video diff\ndefaultDuration=(this.last2SimpleBlockVideoTrackTimecode[1]-this.last2SimpleBlockVideoTrackTimecode[0])*this.timecodeScale;// video delay\nvar delay=this.trackCodecDelay[this.trackTypes.indexOf(1)];// 1 => video\nif(typeof delay===\"number\"){codecDelay=delay;}// video timecode\nlastTimecode=this.last2SimpleBlockVideoTrackTimecode[1];}}else if(this.trackInfo.type===\"video\"){defaultDuration=(this.last2SimpleBlockVideoTrackTimecode[1]-this.last2SimpleBlockVideoTrackTimecode[0])*this.timecodeScale;var delay=this.trackCodecDelay[this.trackInfo.trackNumber];// 2 => audio\nif(typeof delay===\"number\"){codecDelay=delay;}lastTimecode=this.last2SimpleBlockVideoTrackTimecode[1];}else if(this.trackInfo.type===\"audio\"){defaultDuration=(this.last2SimpleBlockAudioTrackTimecode[1]-this.last2SimpleBlockAudioTrackTimecode[0])*this.timecodeScale;var delay=this.trackCodecDelay[this.trackInfo.trackNumber];// 1 => video\nif(typeof delay===\"number\"){codecDelay=delay;}lastTimecode=this.last2SimpleBlockAudioTrackTimecode[1];}// else { not reached }\n}// convert to timecodescale\nvar duration_nanosec=(this.lastClusterTimecode+lastTimecode)*this.timecodeScale+defaultDuration-codecDelay;var duration=duration_nanosec/this.timecodeScale;return Math.floor(duration);},enumerable:true,configurable:true});EBMLReader.prototype.addListener=function(event,listener){return _super.prototype.addListener.call(this,event,listener);};EBMLReader.prototype.put=function(elm){if(!this.hasLoggingStarted){this.hasLoggingStarted=true;if(this.logging&&this.logGroup){console.groupCollapsed(this.logGroup);}}if(elm.type===\"m\"){if(elm.isEnd){console.groupEnd();}else{console.group(elm.name+\":\"+elm.tagStart);}}else if(elm.type===\"b\"){// for debug\n//if(elm.name === \"SimpleBlock\"){\n//const o = EBML.tools.ebmlBlock(elm.value);\n//console.log(elm.name, elm.type, o.trackNumber, o.timecode);\n//}else{\nconsole.log(elm.name,elm.type);//}\n}else{console.log(elm.name,elm.tagStart,elm.type,elm.value);}};return EBMLReader;}(events_1.EventEmitter);exports.default=EBMLReader;;;;;","map":{"version":3,"sources":["/Users/randyadams/IMMORTIFYV2/immortify-app-client/src/react-video-recorder-master/node_modules/ts-ebml/lib/EBMLReader.js"],"names":["__extends","extendStatics","Object","setPrototypeOf","__proto__","Array","d","b","p","hasOwnProperty","__","constructor","prototype","create","defineProperty","exports","value","events_1","require","tools","EBMLReader","_super","_this","call","logGroup","hasLoggingStarted","metadataloaded","chunks","stack","segmentOffset","last2SimpleBlockVideoTrackTimecode","last2SimpleBlockAudioTrackTimecode","lastClusterTimecode","lastClusterPosition","timecodeScale","metadataSize","metadatas","cues","firstVideoBlockRead","firstAudioBlockRead","currentTrack","TrackNumber","TrackType","DefaultDuration","CodecDelay","trackTypes","trackDefaultDuration","trackCodecDelay","trackInfo","type","ended","logging","use_duration_every_simpleblock","use_webp","use_segment_info","drop_default_duration","stop","emit_segment_info","length","pop","console","groupEnd","data","videoTrackNum","indexOf","audioTrackNum","trackNumber","emit","timecode","duration","read","elm","drop","isEnd","parent_1","level","dataEnd","dataSize","dataStart","unknownSize","o","assign","name","push","warn","_a","ebmlBlock","frames_1","frames","CueTime","CueTrack","CueClusterPosition","forEach","frame","startcode","slice","toString","webpBuf","VP8BitStreamToRiffWebPBuffer","webp","Blob","currentTime","tagStart","put","get","defaultDuration","codecDelay","lastTimecode","_defaultDuration","delay","duration_nanosec","Math","floor","enumerable","configurable","addListener","event","listener","groupCollapsed","group","log","EventEmitter","default"],"mappings":"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","sourcesContent":["\"use strict\";\nvar __extends = (this && this.__extends) || (function () {\n    var extendStatics = Object.setPrototypeOf ||\n        ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\n        function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };\n    return function (d, b) {\n        extendStatics(d, b);\n        function __() { this.constructor = d; }\n        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n    };\n})();\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar events_1 = require(\"events\");\nvar tools = require(\"./tools\");\n/**\n * This is an informal code for reference.\n * EBMLReader is a class for getting information to enable seeking Webm recorded by MediaRecorder.\n * So please do not use for regular WebM files.\n */\nvar EBMLReader = (function (_super) {\n    __extends(EBMLReader, _super);\n    function EBMLReader() {\n        var _this = _super.call(this) || this;\n        _this.logGroup = \"\";\n        _this.hasLoggingStarted = false;\n        _this.metadataloaded = false;\n        _this.chunks = [];\n        _this.stack = [];\n        _this.segmentOffset = 0;\n        _this.last2SimpleBlockVideoTrackTimecode = [0, 0];\n        _this.last2SimpleBlockAudioTrackTimecode = [0, 0];\n        _this.lastClusterTimecode = 0;\n        _this.lastClusterPosition = 0;\n        _this.timecodeScale = 1000000; // webm default TimecodeScale is 1ms\n        _this.metadataSize = 0;\n        _this.metadatas = [];\n        _this.cues = [];\n        _this.firstVideoBlockRead = false;\n        _this.firstAudioBlockRead = false;\n        _this.currentTrack = { TrackNumber: -1, TrackType: -1, DefaultDuration: null, CodecDelay: null };\n        _this.trackTypes = [];\n        _this.trackDefaultDuration = [];\n        _this.trackCodecDelay = [];\n        _this.trackInfo = { type: \"nothing\" };\n        _this.ended = false;\n        _this.logging = false;\n        _this.use_duration_every_simpleblock = false;\n        _this.use_webp = false;\n        _this.use_segment_info = true;\n        _this.drop_default_duration = true;\n        return _this;\n    }\n    /**\n     * emit final state.\n     */\n    EBMLReader.prototype.stop = function () {\n        this.ended = true;\n        this.emit_segment_info();\n        // clean up any unclosed Master Elements at the end of the stream.\n        while (this.stack.length) {\n            this.stack.pop();\n            if (this.logging) {\n                console.groupEnd();\n            }\n        }\n        // close main group if set, logging is enabled, and has actually logged anything.\n        if (this.logging && this.hasLoggingStarted && this.logGroup) {\n            console.groupEnd();\n        }\n    };\n    /**\n     * emit chunk info\n     */\n    EBMLReader.prototype.emit_segment_info = function () {\n        var data = this.chunks;\n        this.chunks = [];\n        if (!this.metadataloaded) {\n            this.metadataloaded = true;\n            this.metadatas = data;\n            var videoTrackNum = this.trackTypes.indexOf(1); // find first video track\n            var audioTrackNum = this.trackTypes.indexOf(2); // find first audio track\n            this.trackInfo = videoTrackNum >= 0 && audioTrackNum >= 0 ? { type: \"both\", trackNumber: videoTrackNum }\n                : videoTrackNum >= 0 ? { type: \"video\", trackNumber: videoTrackNum }\n                    : audioTrackNum >= 0 ? { type: \"audio\", trackNumber: audioTrackNum }\n                        : { type: \"nothing\" };\n            if (!this.use_segment_info) {\n                return;\n            }\n            this.emit(\"metadata\", { data: data, metadataSize: this.metadataSize });\n        }\n        else {\n            if (!this.use_segment_info) {\n                return;\n            }\n            var timecode = this.lastClusterTimecode;\n            var duration = this.duration;\n            var timecodeScale = this.timecodeScale;\n            this.emit(\"cluster\", { timecode: timecode, data: data });\n            this.emit(\"duration\", { timecodeScale: timecodeScale, duration: duration });\n        }\n    };\n    EBMLReader.prototype.read = function (elm) {\n        var _this = this;\n        var drop = false;\n        if (this.ended) {\n            // reader is finished\n            return;\n        }\n        if (elm.type === \"m\") {\n            // 閉じタグの自動挿入\n            if (elm.isEnd) {\n                this.stack.pop();\n            }\n            else {\n                var parent_1 = this.stack[this.stack.length - 1];\n                if (parent_1 != null && parent_1.level >= elm.level) {\n                    // 閉じタグなしでレベルが下がったら閉じタグを挿入\n                    this.stack.pop();\n                    // From http://w3c.github.io/media-source/webm-byte-stream-format.html#webm-media-segments\n                    // This fixes logging for webm streams with Cluster of unknown length and no Cluster closing elements.\n                    if (this.logging) {\n                        console.groupEnd();\n                    }\n                    parent_1.dataEnd = elm.dataEnd;\n                    parent_1.dataSize = elm.dataEnd - parent_1.dataStart;\n                    parent_1.unknownSize = false;\n                    var o = Object.assign({}, parent_1, { name: parent_1.name, type: parent_1.type, isEnd: true });\n                    this.chunks.push(o);\n                }\n                this.stack.push(elm);\n            }\n        }\n        if (elm.type === \"m\" && elm.name == \"Segment\") {\n            if (this.segmentOffset != 0) {\n                console.warn(\"Multiple segments detected!\");\n            }\n            this.segmentOffset = elm.dataStart;\n            this.emit(\"segment_offset\", this.segmentOffset);\n        }\n        else if (elm.type === \"b\" && elm.name === \"SimpleBlock\") {\n            var _a = tools.ebmlBlock(elm.data), timecode = _a.timecode, trackNumber = _a.trackNumber, frames_1 = _a.frames;\n            if (this.trackTypes[trackNumber] === 1) {\n                if (!this.firstVideoBlockRead) {\n                    this.firstVideoBlockRead = true;\n                    if (this.trackInfo.type === \"both\" || this.trackInfo.type === \"video\") {\n                        var CueTime = this.lastClusterTimecode + timecode;\n                        this.cues.push({ CueTrack: trackNumber, CueClusterPosition: this.lastClusterPosition, CueTime: CueTime });\n                        this.emit(\"cue_info\", { CueTrack: trackNumber, CueClusterPosition: this.lastClusterPosition, CueTime: this.lastClusterTimecode });\n                        this.emit(\"cue\", { CueTrack: trackNumber, CueClusterPosition: this.lastClusterPosition, CueTime: CueTime });\n                    }\n                }\n                this.last2SimpleBlockVideoTrackTimecode = [this.last2SimpleBlockVideoTrackTimecode[1], timecode];\n            }\n            else if (this.trackTypes[trackNumber] === 2) {\n                if (!this.firstAudioBlockRead) {\n                    this.firstAudioBlockRead = true;\n                    if (this.trackInfo.type === \"audio\") {\n                        var CueTime = this.lastClusterTimecode + timecode;\n                        this.cues.push({ CueTrack: trackNumber, CueClusterPosition: this.lastClusterPosition, CueTime: CueTime });\n                        this.emit(\"cue_info\", { CueTrack: trackNumber, CueClusterPosition: this.lastClusterPosition, CueTime: this.lastClusterTimecode });\n                        this.emit(\"cue\", { CueTrack: trackNumber, CueClusterPosition: this.lastClusterPosition, CueTime: CueTime });\n                    }\n                }\n                this.last2SimpleBlockAudioTrackTimecode = [this.last2SimpleBlockAudioTrackTimecode[1], timecode];\n            }\n            if (this.use_duration_every_simpleblock) {\n                this.emit(\"duration\", { timecodeScale: this.timecodeScale, duration: this.duration });\n            }\n            if (this.use_webp) {\n                frames_1.forEach(function (frame) {\n                    var startcode = frame.slice(3, 6).toString(\"hex\");\n                    if (startcode !== \"9d012a\") {\n                        return;\n                    }\n                    ; // VP8 の場合\n                    var webpBuf = tools.VP8BitStreamToRiffWebPBuffer(frame);\n                    var webp = new Blob([webpBuf], { type: \"image/webp\" });\n                    var currentTime = _this.duration;\n                    _this.emit(\"webp\", { currentTime: currentTime, webp: webp });\n                });\n            }\n        }\n        else if (elm.type === \"m\" && elm.name === \"Cluster\" && elm.isEnd === false) {\n            this.firstVideoBlockRead = false;\n            this.firstAudioBlockRead = false;\n            this.emit_segment_info();\n            this.emit(\"cluster_ptr\", elm.tagStart);\n            this.lastClusterPosition = elm.tagStart;\n        }\n        else if (elm.type === \"u\" && elm.name === \"Timecode\") {\n            this.lastClusterTimecode = elm.value;\n        }\n        else if (elm.type === \"u\" && elm.name === \"TimecodeScale\") {\n            this.timecodeScale = elm.value;\n        }\n        else if (elm.type === \"m\" && elm.name === \"TrackEntry\") {\n            if (elm.isEnd) {\n                this.trackTypes[this.currentTrack.TrackNumber] = this.currentTrack.TrackType;\n                this.trackDefaultDuration[this.currentTrack.TrackNumber] = this.currentTrack.DefaultDuration;\n                this.trackCodecDelay[this.currentTrack.TrackNumber] = this.currentTrack.CodecDelay;\n            }\n            else {\n                this.currentTrack = { TrackNumber: -1, TrackType: -1, DefaultDuration: null, CodecDelay: null };\n            }\n        }\n        else if (elm.type === \"u\" && elm.name === \"TrackType\") {\n            this.currentTrack.TrackType = elm.value;\n        }\n        else if (elm.type === \"u\" && elm.name === \"TrackNumber\") {\n            this.currentTrack.TrackNumber = elm.value;\n        }\n        else if (elm.type === \"u\" && elm.name === \"CodecDelay\") {\n            this.currentTrack.CodecDelay = elm.value;\n        }\n        else if (elm.type === \"u\" && elm.name === \"DefaultDuration\") {\n            // media source api は DefaultDuration を計算するとバグる。\n            // https://bugs.chromium.org/p/chromium/issues/detail?id=606000#c22\n            // chrome 58 ではこれを回避するために DefaultDuration 要素を抜き取った。\n            // chrome 58 以前でもこのタグを抜き取ることで回避できる\n            if (this.drop_default_duration) {\n                console.warn(\"DefaultDuration detected!, remove it\");\n                drop = true;\n            }\n            else {\n                this.currentTrack.DefaultDuration = elm.value;\n            }\n        }\n        else if (elm.name === \"unknown\") {\n            console.warn(elm);\n        }\n        if (!this.metadataloaded && elm.dataEnd > 0) {\n            this.metadataSize = elm.dataEnd;\n        }\n        if (!drop) {\n            this.chunks.push(elm);\n        }\n        if (this.logging) {\n            this.put(elm);\n        }\n    };\n    Object.defineProperty(EBMLReader.prototype, \"duration\", {\n        /**\n         * DefaultDuration が定義されている場合は最後のフレームのdurationも考慮する\n         * 単位 timecodeScale\n         *\n         * !!! if you need duration with seconds !!!\n         * ```js\n         * const nanosec = reader.duration * reader.timecodeScale;\n         * const sec = nanosec / 1000 / 1000 / 1000;\n         * ```\n         */\n        get: function () {\n            if (this.trackInfo.type === \"nothing\") {\n                console.warn(\"no video, no audio track\");\n                return 0;\n            }\n            // defaultDuration は 生の nano sec\n            var defaultDuration = 0;\n            // nanoseconds\n            var codecDelay = 0;\n            var lastTimecode = 0;\n            var _defaultDuration = this.trackDefaultDuration[this.trackInfo.trackNumber];\n            if (typeof _defaultDuration === \"number\") {\n                defaultDuration = _defaultDuration;\n            }\n            else {\n                // https://bugs.chromium.org/p/chromium/issues/detail?id=606000#c22\n                // default duration がないときに使う delta\n                if (this.trackInfo.type === \"both\") {\n                    if (this.last2SimpleBlockAudioTrackTimecode[1] > this.last2SimpleBlockVideoTrackTimecode[1]) {\n                        // audio diff\n                        defaultDuration = (this.last2SimpleBlockAudioTrackTimecode[1] - this.last2SimpleBlockAudioTrackTimecode[0]) * this.timecodeScale;\n                        // audio delay\n                        var delay = this.trackCodecDelay[this.trackTypes.indexOf(2)]; // 2 => audio\n                        if (typeof delay === \"number\") {\n                            codecDelay = delay;\n                        }\n                        // audio timecode\n                        lastTimecode = this.last2SimpleBlockAudioTrackTimecode[1];\n                    }\n                    else {\n                        // video diff\n                        defaultDuration = (this.last2SimpleBlockVideoTrackTimecode[1] - this.last2SimpleBlockVideoTrackTimecode[0]) * this.timecodeScale;\n                        // video delay\n                        var delay = this.trackCodecDelay[this.trackTypes.indexOf(1)]; // 1 => video\n                        if (typeof delay === \"number\") {\n                            codecDelay = delay;\n                        }\n                        // video timecode\n                        lastTimecode = this.last2SimpleBlockVideoTrackTimecode[1];\n                    }\n                }\n                else if (this.trackInfo.type === \"video\") {\n                    defaultDuration = (this.last2SimpleBlockVideoTrackTimecode[1] - this.last2SimpleBlockVideoTrackTimecode[0]) * this.timecodeScale;\n                    var delay = this.trackCodecDelay[this.trackInfo.trackNumber]; // 2 => audio\n                    if (typeof delay === \"number\") {\n                        codecDelay = delay;\n                    }\n                    lastTimecode = this.last2SimpleBlockVideoTrackTimecode[1];\n                }\n                else if (this.trackInfo.type === \"audio\") {\n                    defaultDuration = (this.last2SimpleBlockAudioTrackTimecode[1] - this.last2SimpleBlockAudioTrackTimecode[0]) * this.timecodeScale;\n                    var delay = this.trackCodecDelay[this.trackInfo.trackNumber]; // 1 => video\n                    if (typeof delay === \"number\") {\n                        codecDelay = delay;\n                    }\n                    lastTimecode = this.last2SimpleBlockAudioTrackTimecode[1];\n                } // else { not reached }\n            }\n            // convert to timecodescale\n            var duration_nanosec = ((this.lastClusterTimecode + lastTimecode) * this.timecodeScale) + defaultDuration - codecDelay;\n            var duration = duration_nanosec / this.timecodeScale;\n            return Math.floor(duration);\n        },\n        enumerable: true,\n        configurable: true\n    });\n    EBMLReader.prototype.addListener = function (event, listener) {\n        return _super.prototype.addListener.call(this, event, listener);\n    };\n    EBMLReader.prototype.put = function (elm) {\n        if (!this.hasLoggingStarted) {\n            this.hasLoggingStarted = true;\n            if (this.logging && this.logGroup) {\n                console.groupCollapsed(this.logGroup);\n            }\n        }\n        if (elm.type === \"m\") {\n            if (elm.isEnd) {\n                console.groupEnd();\n            }\n            else {\n                console.group(elm.name + \":\" + elm.tagStart);\n            }\n        }\n        else if (elm.type === \"b\") {\n            // for debug\n            //if(elm.name === \"SimpleBlock\"){\n            //const o = EBML.tools.ebmlBlock(elm.value);\n            //console.log(elm.name, elm.type, o.trackNumber, o.timecode);\n            //}else{\n            console.log(elm.name, elm.type);\n            //}\n        }\n        else {\n            console.log(elm.name, elm.tagStart, elm.type, elm.value);\n        }\n    };\n    return EBMLReader;\n}(events_1.EventEmitter));\nexports.default = EBMLReader;\n;\n;\n;\n;\n"]},"metadata":{},"sourceType":"module"}